(()=>{"use strict";var e={800:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FreeeAPIClient=void 0;const r=a(941);t.FreeeAPIClient=class{constructor(e,t){this.tokenManager=e,this.axios=t}get(e,t,a){return this.tokenManager.get(a).then((a=>{const r={Authorization:`Bearer ${a}`,"X-Api-Version":"2020-06-15","Content-Type":"application/json"};return this.axios.get(e,{params:t,headers:r})}))}post(e,t,a){return this.tokenManager.get(a).then((a=>{let s=t,i={},o="application/json";if("api/1/receipts"===e){const e=new r;Object.keys(t).forEach((a=>{e.append(a,t[a])})),s=e,i=e.getHeaders(),o="multipart/form-data"}return i.Authorization=`Bearer ${a}`,i["X-Api-Version"]="2020-06-15",i["Content-Type"]=o,this.axios.post(e,s,{maxContentLength:104857600,headers:i})}))}put(e,t,a){return this.tokenManager.get(a).then((a=>{const r={Authorization:`Bearer ${a}`,"X-Api-Version":"2020-06-15","Content-Type":"application/json"};return this.axios.put(e,t,{headers:r})}))}delete(e,t,a){return this.tokenManager.get(a).then((a=>{const r={Authorization:`Bearer ${a}`,"X-Api-Version":"2020-06-15","Content-Type":"application/json"};return this.axios.delete(e,{data:t,headers:r})}))}}},729:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FreeeFirebaseAuthClient=void 0;const r=a(123);t.FreeeFirebaseAuthClient=class{constructor(e,t,a,s,i){this.admin=e,this.oauth2=t,this.axios=a,this.tokenManager=s;const o=i.freee,n=r.ConfigManager.getFunctionsConfigs();this.clientId=n.freee.client_id,this.clientSecret=n.freee.client_secret,this.redirectPath=r.ConfigManager.get(o,r.ConfigKeys.redirectPath),this.callbackPath=r.ConfigManager.get(o,r.ConfigKeys.callbackPath),this.companiesPath=r.ConfigManager.get(o,r.ConfigKeys.companiesPath),this.homePath=r.ConfigManager.get(o,r.ConfigKeys.homePath),this.appHost=r.ConfigManager.get(o,r.ConfigKeys.appHost),this.authHost=r.ConfigManager.get(o,r.ConfigKeys.authHost),this.apiKey=i.firebase&&i.firebase.apiKey}redirect(e){const t=this.oauth2.authorizationCode.authorizeURL({redirect_uri:`${this.authHost}${this.getCallbackPath()}`});e.redirect(t)}async callback(e,t){try{const a=await this.oauth2.authorizationCode.getToken({client_id:this.clientId,client_secret:this.clientSecret,code:e,redirect_uri:`${this.authHost}${this.getCallbackPath()}`}),r={accessToken:a.access_token,refreshToken:a.refresh_token,expiresIn:a.expires_in,createdAt:a.created_at},s=await this.getFreeeUser(r.accessToken),i=s.data.user.id,o=s.data.user.email,n=s.data.user.display_name?s.data.user.display_name:"",c=await this.createFirebaseAccount(i,o,n,r);t.redirect(`${this.appHost}${this.homePath}?token=${c}`)}catch(e){console.error("Some error occured on login process:",e),t.send(this.signInRefusedTemplate())}}getRedirectPath(){return this.redirectPath}getCallbackPath(){return this.callbackPath}getCompaniesPath(){return this.companiesPath}async createCryptoKey(e){await this.tokenManager.createCryptoKey(e)}getFreeeUser(e){return this.axios.get("/api/1/users/me?companies=true",{headers:{Authorization:`Bearer ${e}`}})}async createFirebaseAccount(e,t,a,r){const s=e.toString();return await this.tokenManager.save(s,t,r),await this.admin.auth().updateUser(s,{email:t,displayName:a}).catch((async e=>{if("auth/user-not-found"===e.code)return await this.admin.auth().createUser({uid:s,email:t,displayName:a});throw e})),await this.admin.auth().createCustomToken(s)}signInRefusedTemplate(){return`\n      <script>\n        window.location.href = '${this.appHost}'\n      <\/script>`}}},597:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=a(167),s=a(509),i=a(800),o=a(729),n=a(123),c=a(747),h=a(644);t.default=class{constructor(e,t){const u=e.freee;this.admin=t?s.initializeApp({credential:s.credential.cert(t),databaseURL:`https://${t.project_id}.firebaseio.com`,storageBucket:`${t.project_id}.appspot.com`}):s.initializeApp();const p=n.ConfigManager.get(e.firebase,n.ConfigKeys.cryptoKeyBucket),d=p?new c.default(this.admin.storage().bucket(p)):null,l=a(875).create(this.getCredentials(u)),f=new h.TokenManager(this.admin,l,d);r.default.defaults.baseURL=n.ConfigManager.get(u,n.ConfigKeys.apiHost),this.apiClient=new i.FreeeAPIClient(f,r.default),this.firebaseAuthClient=new o.FreeeFirebaseAuthClient(this.admin,l,r.default,f,e)}firebaseApp(){return this.admin}api(){return this.apiClient}auth(){return this.firebaseAuthClient}getCredentials(e){const t=n.ConfigManager.getFunctionsConfigs().freee;return{client:{id:t.client_id,secret:t.client_secret},auth:{tokenHost:n.ConfigManager.get(e,n.ConfigKeys.tokenHost),authorizePath:n.ConfigManager.get(e,n.ConfigKeys.authorizePath),tokenPath:n.ConfigManager.get(e,n.ConfigKeys.tokenPath)}}}}},123:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ConfigManager=t.ConfigKeys=void 0;const r=a(860),s=(r.SUPPORTED_REGIONS,JSON.parse(process.env.FIREBASE_CONFIG).projectId),i=r.config().env&&r.config().env.region?r.config().env.region:"asia-northeast1";var o;!function(e){e.apiHost="apiHost",e.appHost="appHost",e.authHost="authHost",e.redirectPath="redirectPath",e.callbackPath="callbackPath",e.companiesPath="companiesPath",e.homePath="homePath",e.tokenHost="tokenHost",e.authorizePath="authorizePath",e.tokenPath="tokenPath",e.cryptoKeyBucket="cryptoKeyBucket"}(o=t.ConfigKeys||(t.ConfigKeys={}));const n={freee:[{key:o.apiHost,default:"https://api.freee.co.jp",production:"https://api.freee.co.jp"},{key:o.appHost,default:"http://localhost:5000",production:`https://${s}.web.app`},{key:o.authHost,default:`http://localhost:5001/${s}/${i}/api/auth`,production:`https://${i}-${s}.cloudfunctions.net/api/auth`},{key:o.redirectPath,default:"/redirect"},{key:o.callbackPath,default:"/callback"},{key:o.companiesPath,default:"/companies"},{key:o.homePath,default:"/"},{key:o.tokenHost,default:"https://accounts.secure.freee.co.jp",production:"https://accounts.secure.freee.co.jp"},{key:o.authorizePath,default:"/public_api/authorize"},{key:o.tokenPath,default:"/public_api/token"}],firebase:[{key:o.cryptoKeyBucket,default:`${s}.appspot.com`}]};t.ConfigManager=class{static get(e,t){return e&&this.hasKey(e,t)?e[t]:this.getDefaultValue(t)}static getFunctionsConfigs(){return r.config()}static getDefaultValue(e){const t=[].concat(n.freee).concat(n.firebase).find((t=>t.key===e));return this.isProduction()&&t.production?t.production:t.default}static isProduction(){const e=this.getFunctionsConfigs();return e.env&&"production"===e.env.mode}static hasKey(e,t){return Object.keys(e).find((e=>e===t))}}},747:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=a(146),s=a(347),i="aes-256-cbc",o="base64",n="utf8";t.default=class{constructor(e){this.bucket=e,this.keyCache={}}async createCryptoKey(e){const t=(0,r.format)(e,"yyyyMM");return this.create(t)}async encrypt(e){const{accessToken:t,refreshToken:a}=e,c=(0,r.format)(new Date,"yyyyMM"),h=await this.getKey(c),u=s.randomBytes(16);return Object.assign(Object.assign({},e),{accessToken:this.crypt(t,this.cipher(h,u),n,o),refreshToken:this.crypt(a,this.cipher(h,u),n,o),keyFileName:c,algorithm:i,iv:u})}async decrypt(e){const{accessToken:t,refreshToken:a,keyFileName:r,algorithm:s,iv:i}=e,c=await this.getKey(r);return Object.assign(Object.assign({},e),{accessToken:this.crypt(t,this.decipher(s,c,i),o,n),refreshToken:this.crypt(a,this.decipher(s,c,i),o,n)})}cipher(e,t){return s.createCipheriv(i,e,t)}decipher(e,t,a){return s.createDecipheriv(e,t,a)}async getKey(e){if(this.keyCache[e])return this.keyCache[e];try{return await this.get(e)}catch(t){return await this.exists(e)||(console.info("No key file for:",e),await this.create(e)),await this.get(e)}}crypt(e,t,a,r){let s=t.update(e,a,r);return s+=t.final(r),s}async create(e){const t=s.randomBytes(32),a=this.bucket.file(e);await a.save(t),console.log("New crypto key is successfully created for:",e)}async get(e){const t=await this.bucket.file(e).download();return this.keyCache[e]=t[0],console.log("Crypto key is retrieved from storage for:",e),t[0]}async exists(e){const t=(await this.bucket.file(e).exists())[0];return console.log(`Crypto key ${t?"is":"is not"} exists storage for:`,e),t}}},644:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TokenManager=void 0,t.TokenManager=class{constructor(e,t,a){this.admin=e,this.oauth2=t,this.cryptor=a,this.tokenCache={}}async get(e){const t=await this.getTokenFromFirebase(e);if(!this.tokenExpired(t))return t.accessToken;console.log("accessToken has been expired for user:",e);try{return await this.refreshToken(t,e)}catch(t){if(t.output&&401===t.output.statusCode){console.log("Token is already refreshed in other instance:",t);const a=await this.getTokenFromFirebase(e,!0);if(this.tokenExpired(a))throw console.error("Can not get available token:",t),t;return a.accessToken}throw t}}async save(e,t,a){const r=await this.encrypt(a);await this.admin.firestore().doc(`/freeeTokens/${e}`).set(Object.assign(Object.assign({},r),{email:t}))}async createCryptoKey(e){this.cryptor&&await this.cryptor.createCryptoKey(e)}async refreshToken(e,t){const a={access_token:e.accessToken,refresh_token:e.refreshToken,expires_in:e.expiresIn},r=this.oauth2.accessToken.create(a),s=await r.refresh(),i=await this.encrypt({accessToken:s.token.access_token,refreshToken:s.token.refresh_token,expiresIn:s.token.expires_in,createdAt:s.token.created_at});return this.tokenCache[t]=i,await this.admin.firestore().doc(`/freeeTokens/${t}`).set(Object.assign({},i),{merge:!0}),console.log("accessToken is successfully refreshed for user:",t),s.token.access_token}tokenExpired(e){const t=e.createdAt+e.expiresIn-300;return(new Date).getTime()/1e3>=t}async getTokenFromFirebase(e,t){if(!t){const t=this.tokenCache[e];if(t)return await this.decrypt(t)}const a=(await this.admin.firestore().doc(`/freeeTokens/${e}`).get()).data();return this.tokenCache[e]=a,console.log("Token is retrieved from firestore for user:",e),await this.decrypt(a)}async encrypt(e){return this.cryptor?await this.cryptor.encrypt(e):e}async decrypt(e){return this.cryptor?await this.cryptor.decrypt(e):e}}},167:e=>{e.exports=require("axios")},347:e=>{e.exports=require("crypto")},146:e=>{e.exports=require("date-fns")},509:e=>{e.exports=require("firebase-admin")},860:e=>{e.exports=require("firebase-functions")},941:e=>{e.exports=require("form-data")},875:e=>{e.exports=require("simple-oauth2")}},t={};function a(r){var s=t[r];if(void 0!==s)return s.exports;var i=t[r]={exports:{}};return e[r](i,i.exports,a),i.exports}var r={};for(var s in(()=>{var e=r;Object.defineProperty(e,"__esModule",{value:!0}),e.FreeeServerSDK=void 0;const t=a(597);e.FreeeServerSDK=t.default})(),r)this[s]=r[s];r.__esModule&&Object.defineProperty(this,"__esModule",{value:!0})})();